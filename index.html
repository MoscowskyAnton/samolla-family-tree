<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Генеалогическое древо собак — с общим списком собак</title>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; }
  .tree { position: relative; max-width: 1000px; margin: auto; }
  #dogs-list {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    justify-content: center;
    margin-bottom: 50px;
    border-bottom: 2px solid #ccc;
    padding-bottom: 20px;
  }
  .dog {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    background: #f0f0f0;
    box-shadow: 0 0 8px rgba(0,0,0,0.1);
    text-align: center;
    padding-top: 10px;
    font-size: 14px;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  .dog img {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    object-fit: cover;
    margin-bottom: 5px;
  }
  .male { border: 3px solid #3399ff; }
  .female { border: 3px solid #ff6699; }

  #litters-list {
    display: flex;
    flex-direction: column;
    gap: 60px;
  }
  .litter-block {
    position: relative;
    padding-left: 20px;
  }
  .litter-name {
    font-weight: bold;
    margin-bottom: 10px;
  }
  .litter {
    border-radius: 15px;
    border: 2px solid #999;
    padding: 10px;
    display: flex;
    gap: 20px;
    justify-content: center;
    width: max-content;
  }
  /* svg для стрелок */
  svg#arrows-svg {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    overflow: visible;
  }
</style>
</head>
<body>

<div class="tree" id="tree-container">
  <div id="dogs-list"></div>
  <div id="litters-list"></div>
  <svg id="arrows-svg"></svg>
</div>

<script>
// Создаём DOM элемент собаки
function createDogNode(dog) {
  const dogDiv = document.createElement('div');
  dogDiv.classList.add('dog');
  dogDiv.classList.add(dog.sex === 'male' ? 'male' : 'female');
  dogDiv.dataset.name = dog.name; // Атрибут для поиска по имени

  const img = document.createElement('img');
  img.src = dog.photo;
  img.alt = dog.name;

  const nameDiv = document.createElement('div');
  nameDiv.textContent = dog.name;

  dogDiv.appendChild(img);
  dogDiv.appendChild(nameDiv);
  return dogDiv;
}

// Построение дерева
function buildTree(data) {
  const dogsList = document.getElementById('dogs-list');
  const littersList = document.getElementById('litters-list');

  dogsList.innerHTML = '';
  littersList.innerHTML = '';

  // Отрисовываем всех собак один раз
  data.dogs.forEach(dog => {
    dogsList.appendChild(createDogNode(dog));
  });

  // Отрисовываем помёты с щенками
  data.litters.forEach((litter, idx) => {
    const litterBlock = document.createElement('div');
    litterBlock.classList.add('litter-block');
    litterBlock.dataset.litterIndex = idx; // для идентификации

    const litterName = document.createElement('div');
    litterName.classList.add('litter-name');
    litterName.textContent = litter.name || `Помёт ${idx + 1}`;
    litterBlock.appendChild(litterName);

    const puppiesDiv = document.createElement('div');
    puppiesDiv.classList.add('litter');

    litter.puppies.forEach(puppyName => {
      const puppy = findDogByName(data.dogs, puppyName);
      if (puppy) {
        puppiesDiv.appendChild(createDogNode(puppy));
      }
    });

    litterBlock.appendChild(puppiesDiv);
    littersList.appendChild(litterBlock);
  });

  // Делаем отрисовку стрелок с задержкой, чтобы DOM обновился
  setTimeout(() => drawAllArrows(data), 50);
}

// Поиск собаки по уникальному имени
function findDogByName(dogs, name) {
  return dogs.find(d => d.name === name) || null;
}

// Создание стрелки SVG
function createArrow(x1, y1, x2, y2) {
  const line = document.createElementNS("http://www.w3.org/2000/svg","line");
  line.setAttribute('x1', x1);
  line.setAttribute('y1', y1);
  line.setAttribute('x2', x2);
  line.setAttribute('y2', y2);
  line.setAttribute('stroke', '#444');
  line.setAttribute('stroke-width', '2');
  line.setAttribute('marker-end', 'url(#arrowhead)');
  return line;
}

// Отрисовываем все стрелки от собак к помётам
function drawAllArrows(data) {
  const svg = document.getElementById('arrows-svg');
  const tree = document.getElementById('tree-container');
  svg.innerHTML = '';
  svg.style.width = tree.offsetWidth + 'px';
  svg.style.height = tree.offsetHeight + 'px';

  // Добавляем маркер стрелки
  const defs = document.createElementNS("http://www.w3.org/2000/svg", "defs");
  const marker = document.createElementNS("http://www.w3.org/2000/svg", "marker");
  marker.setAttribute('id', 'arrowhead');
  marker.setAttribute('markerWidth', '10');
  marker.setAttribute('markerHeight', '7');
  marker.setAttribute('refX', '0');
  marker.setAttribute('refY', '3.5');
  marker.setAttribute('orient', 'auto');
  const polygon = document.createElementNS("http://www.w3.org/2000/svg","polygon");
  polygon.setAttribute('points', '0 0, 10 3.5, 0 7');
  polygon.setAttribute('fill', '#444');
  marker.appendChild(polygon);
  defs.appendChild(marker);
  svg.appendChild(defs);

  const containerRect = tree.getBoundingClientRect();

  data.litters.forEach((litter, idx) => {
    const litterBlock = document.querySelector(`.litter-block[data-litter-index="${idx}"]`);
    if (!litterBlock) return;

    const puppiesDiv = litterBlock.querySelector('.litter');
    if (!puppiesDiv) return;

    const puppiesRect = puppiesDiv.getBoundingClientRect();

    ['father', 'mother'].forEach(parentType => {
      const parentName = litter[parentType];
      if (!parentName) return;

      const parentNode = document.querySelector(`#dogs-list .dog[data-name="${parentName}"]`);
      if(!parentNode) return;

      const parentRect = parentNode.getBoundingClientRect();

      // Координаты для линии: от центра родителя к центру помёта (щенков)
      const x1 = parentRect.left + parentRect.width / 2 - containerRect.left;
      const y1 = parentRect.top + parentRect.height - containerRect.top; // низ кружка родителя
      const x2 = puppiesRect.left + puppiesRect.width / 2 - containerRect.left;
      const y2 = puppiesRect.top - containerRect.top; // верх помёта

      svg.appendChild(createArrow(x1, y1, x2, y2));
    });
  });
}

// При изменении размера окна пересчитываем стрелки
window.addEventListener('resize', () => {
  if(window.currentData){
    drawAllArrows(window.currentData);
  }
});

// Пример загрузки из JSON - data.json должен находиться в репозитории вместе с этим index.html
fetch('data.json')
  .then(res => res.json())
  .then(data => {
    window.currentData = data;
    buildTree(data);
  })
  .catch(err => {
    console.error('Ошибка загрузки данных:', err);
  });
</script>

</body>
</html>
