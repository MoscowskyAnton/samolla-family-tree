<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Генеалогическое древо собак с внешним JSON</title>
<style>
  body { font-family: Arial, sans-serif; }
  .tree { position: relative; margin: 20px; }
  .parent { display: flex; justify-content: center; gap: 40px; margin-bottom: 20px; }
  .dog {
    width: 100px; height: 100px; border-radius: 50%; background: #f0f0f0;
    box-shadow: 0 0 8px rgba(0,0,0,0.1); text-align: center; padding-top: 10px;
    position: relative; font-size: 14px;
  }
  .dog img {
    width: 60px; height: 60px; border-radius: 50%; object-fit: cover; margin-bottom: 5px;
  }
  .male { border: 3px solid #3399ff; }
  .female { border: 3px solid #ff6699; }
  .litter {
    border-radius: 15px; border: 2px solid #999; padding: 10px;
    display: flex; gap: 20px; justify-content: center; width: max-content; margin: 0 auto;
  }
  svg {
    position: absolute; top: 0; left: 0; pointer-events: none;
  }
</style>
</head>
<body>
<div class="tree" id="tree-container">
  <svg id="arrows"></svg>
</div>
<script>

// Функция для поиска собаки по имени
function findDogByName(dogs, name) {
  return dogs.find(dog => dog.name === name);
}

function createDogNode(dog) {
  const dogDiv = document.createElement('div');
  dogDiv.classList.add('dog');
  dogDiv.classList.add(dog.sex === 'male' ? 'male' : 'female');

  const img = document.createElement('img');
  img.src = dog.photo;
  img.alt = dog.name;

  const nameDiv = document.createElement('div');
  nameDiv.textContent = dog.name;

  dogDiv.appendChild(img);
  dogDiv.appendChild(nameDiv);

  return dogDiv;
}

function buildTree(data) {
  const container = document.getElementById('tree-container');
  container.innerHTML = '';

  data.litters.forEach(litter => {
    const litterBlock = document.createElement('div');
    litterBlock.classList.add('litter-block');
    litterBlock.style.marginBottom = '60px';

    const father = findDogByName(data.dogs, litter.father);
    const mother = findDogByName(data.dogs, litter.mother);

    const parentsDiv = document.createElement('div');
    parentsDiv.classList.add('parent');

    if (father) parentsDiv.appendChild(createDogNode(father));
    if (mother) parentsDiv.appendChild(createDogNode(mother));
    litterBlock.appendChild(parentsDiv);

    const puppiesDiv = document.createElement('div');
    puppiesDiv.classList.add('litter');
    litter.puppies.forEach(puppyName => {
      const puppy = findDogByName(data.dogs, puppyName);
      if (puppy) puppiesDiv.appendChild(createDogNode(puppy));
    });
    litterBlock.appendChild(puppiesDiv);

    const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
    svg.classList.add('arrows-svg');
    svg.style.position = 'relative';
    svg.style.width = '100%';
    svg.style.height = '100px';
    litterBlock.appendChild(svg);

    container.appendChild(litterBlock);

    drawArrowsForLitter(litterBlock, father, mother, puppiesDiv, svg);
  });
}

function drawArrowsForLitter(litterBlock, father, mother, puppiesDiv, svg) {
  svg.innerHTML = '';

  const containerRect = litterBlock.getBoundingClientRect();

  if (!father || !mother || !puppiesDiv) return;

  const fatherDiv = Array.from(litterBlock.querySelectorAll('.dog')).find(d => d.textContent.includes(father.name));
  const motherDiv = Array.from(litterBlock.querySelectorAll('.dog')).find(d => d.textContent.includes(mother.name));

  if (!fatherDiv || !motherDiv) return;

  const fatherRect = fatherDiv.getBoundingClientRect();
  const motherRect = motherDiv.getBoundingClientRect();
  const puppiesRect = puppiesDiv.getBoundingClientRect();

  const fatherX = fatherRect.left + fatherRect.width / 2 - containerRect.left;
  const fatherY = fatherRect.bottom - containerRect.top;

  const motherX = motherRect.left + motherRect.width / 2 - containerRect.left;
  const motherY = motherRect.bottom - containerRect.top;

  const puppiesX = puppiesRect.left + puppiesRect.width / 2 - containerRect.left;
  const puppiesY = puppiesRect.top - containerRect.top;

  function createArrow(x1, y1, x2, y2) {
    const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
    line.setAttribute('x1', x1);
    line.setAttribute('y1', y1);
    line.setAttribute('x2', x2);
    line.setAttribute('y2', y2);
    line.setAttribute('stroke', '#444');
    line.setAttribute('stroke-width', '2');
    line.setAttribute('marker-end', 'url(#arrowhead)');
    return line;
  }

  const defs = document.createElementNS("http://www.w3.org/2000/svg", "defs");
  const marker = document.createElementNS("http://www.w3.org/2000/svg", "marker");
  marker.setAttribute('id', 'arrowhead');
  marker.setAttribute('markerWidth', '10');
  marker.setAttribute('markerHeight', '7');
  marker.setAttribute('refX', '0');
  marker.setAttribute('refY', '3.5');
  marker.setAttribute('orient', 'auto');

  const polygon = document.createElementNS("http://www.w3.org/2000/svg", "polygon");
  polygon.setAttribute('points', '0 0, 10 3.5, 0 7');
  polygon.setAttribute('fill', '#444');
  marker.appendChild(polygon);
  defs.appendChild(marker);
  svg.appendChild(defs);

  svg.appendChild(createArrow(fatherX, fatherY, puppiesX, puppiesY));
  svg.appendChild(createArrow(motherX, motherY, puppiesX, puppiesY));
}

window.addEventListener('resize', () => {
  const container = document.getElementById('tree-container');
  if (!container || !window.currentData) return;

  container.querySelectorAll('.litter-block').forEach((block, i) => {
    const litter = window.currentData.litters[i];
    if (!litter) return;

    const father = window.currentData.dogs.find(d => d.name === litter.father);
    const mother = window.currentData.dogs.find(d => d.name === litter.mother);
    const puppiesDiv = block.querySelector('.litter');
    const svg = block.querySelector('svg');
    if (father && mother && puppiesDiv && svg) {
      drawArrowsForLitter(block, father, mother, puppiesDiv, svg);
    }
  });
});

// Загрузка из JSON
fetch('data.json')
  .then(r => r.json())
  .then(data => {
    window.currentData = data;
    buildTree(data);
  })
  .catch(console.error);

</script>
</body>
</html>
