<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Генеалогическое древо собак — улучшенный пример</title>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; }
  .tree { position: relative; max-width: 1000px; margin: auto; }
  .litter-block { margin-bottom: 60px; }
  .parent {
    display: flex;
    justify-content: center;
    gap: 40px;
    margin-bottom: 20px;
  }
  .dog {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    background: #f0f0f0;
    box-shadow: 0 0 8px rgba(0,0,0,0.1);
    text-align: center;
    padding-top: 10px;
    font-size: 14px;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  .dog img {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    object-fit: cover;
    margin-bottom: 5px;
  }
  .male { border: 3px solid #3399ff; }
  .female { border: 3px solid #ff6699; }
  .litter {
    border-radius: 15px;
    border: 2px solid #999;
    padding: 10px;
    display: flex;
    gap: 20px;
    justify-content: center;
    width: max-content;
    margin: 0 auto;
  }
  svg {
    position: absolute;
    top: 0;
    left: 0;
    pointer-events: none;
    overflow: visible;
  }
</style>
</head>
<body>

<div class="tree" id="tree-container"></div>

<script>
// Поиск собаки по имени, возвращает объект собаки или null
function findDogByName(dogs, name) {
  return dogs.find(d => d.name === name) || null;
}

// Создаём DOM элемент собаки
function createDogNode(dog) {
  const dogDiv = document.createElement('div');
  dogDiv.classList.add('dog');
  dogDiv.classList.add(dog.sex === 'male' ? 'male' : 'female');

  const img = document.createElement('img');
  img.src = dog.photo;
  img.alt = dog.name;

  const nameDiv = document.createElement('div');
  nameDiv.textContent = dog.name;

  dogDiv.appendChild(img);
  dogDiv.appendChild(nameDiv);

  return dogDiv;
}

// Отрисовка стрелок между родителями и щенками
function drawArrowsForLitter(litterBlock, father, mother, puppiesDiv, svg) {
  svg.innerHTML = '';

  const containerRect = litterBlock.getBoundingClientRect();
  if (!father || !mother || !puppiesDiv) return;

  // Находим DOM элементы собак с именами родителей
  const dogDivs = litterBlock.querySelectorAll('.dog');
  const fatherDiv = Array.from(dogDivs).find(d => d.textContent === father.name);
  const motherDiv = Array.from(dogDivs).find(d => d.textContent === mother.name);

  if (!fatherDiv || !motherDiv) return;

  const fatherRect = fatherDiv.getBoundingClientRect();
  const motherRect = motherDiv.getBoundingClientRect();
  const puppiesRect = puppiesDiv.getBoundingClientRect();

  const fatherX = fatherRect.left + fatherRect.width / 2 - containerRect.left;
  const fatherY = fatherRect.bottom - containerRect.top;

  const motherX = motherRect.left + motherRect.width / 2 - containerRect.left;
  const motherY = motherRect.bottom - containerRect.top;

  const puppiesX = puppiesRect.left + puppiesRect.width / 2 - containerRect.left;
  const puppiesY = puppiesRect.top - containerRect.top;

  const createArrow = (x1, y1, x2, y2) => {
    const line = document.createElementNS("http://www.w3.org/2000/svg","line");
    line.setAttribute('x1', x1);
    line.setAttribute('y1', y1);
    line.setAttribute('x2', x2);
    line.setAttribute('y2', y2);
    line.setAttribute('stroke', '#444');
    line.setAttribute('stroke-width', '2');
    line.setAttribute('marker-end', 'url(#arrowhead)');
    return line;
  };

  // Определяем маркер стрелки
  const defs = document.createElementNS("http://www.w3.org/2000/svg","defs");
  const marker = document.createElementNS("http://www.w3.org/2000/svg","marker");
  marker.setAttribute('id', 'arrowhead');
  marker.setAttribute('markerWidth', '10');
  marker.setAttribute('markerHeight', '7');
  marker.setAttribute('refX', '0');
  marker.setAttribute('refY', '3.5');
  marker.setAttribute('orient', 'auto');
  const polygon = document.createElementNS("http://www.w3.org/2000/svg","polygon");
  polygon.setAttribute('points', '0 0, 10 3.5, 0 7');
  polygon.setAttribute('fill', '#444');
  marker.appendChild(polygon);
  defs.appendChild(marker);
  svg.appendChild(defs);

  // Добавляем стрелки
  svg.appendChild(createArrow(fatherX, fatherY, puppiesX, puppiesY));
  svg.appendChild(createArrow(motherX, motherY, puppiesX, puppiesY));
}

// Построение всего дерева
function buildTree(data) {
  const container = document.getElementById('tree-container');
  container.innerHTML = '';

  data.litters.forEach(litter => {
    const litterBlock = document.createElement('div');
    litterBlock.classList.add('litter-block');
    litterBlock.style.position = 'relative';
    litterBlock.style.marginBottom = '80px';

    // Находим собак родителей
    const father = findDogByName(data.dogs, litter.father);
    const mother = findDogByName(data.dogs, litter.mother);

    // Родители
    const parentsDiv = document.createElement('div');
    parentsDiv.classList.add('parent');
    if (father) parentsDiv.appendChild(createDogNode(father));
    if (mother) parentsDiv.appendChild(createDogNode(mother));
    litterBlock.appendChild(parentsDiv);

    // Помёт
    const puppiesDiv = document.createElement('div');
    puppiesDiv.classList.add('litter');
    litter.puppies.forEach(puppyName => {
      const puppy = findDogByName(data.dogs, puppyName);
      if (puppy) puppiesDiv.appendChild(createDogNode(puppy));
    });
    litterBlock.appendChild(puppiesDiv);

    // SVG для стрелок внутри блока
    const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
    svg.style.position = 'absolute';
    svg.style.top = '0';
    svg.style.left = '0';
    svg.style.width = '100%';
    svg.style.height = '150px';
    svg.style.overflow = 'visible';
    litterBlock.appendChild(svg);

    container.appendChild(litterBlock);

    // Небольшая задержка, чтобы DOM успел обновиться и получить координаты
    setTimeout(() => {
      drawArrowsForLitter(litterBlock, father, mother, puppiesDiv, svg);
    }, 50);
  });
}

// Перестраиваем стрелки при изменении размеров окна
window.addEventListener('resize', () => {
  const container = document.getElementById('tree-container');
  if (!container || !window.currentData) return;

  const litterBlocks = container.querySelectorAll('.litter-block');
  litterBlocks.forEach((block, idx) => {
    const litter = window.currentData.litters[idx];
    if (!litter) return;
    const father = findDogByName(window.currentData.dogs, litter.father);
    const mother = findDogByName(window.currentData.dogs, litter.mother);
    const puppiesDiv = block.querySelector('.litter');
    const svg = block.querySelector('svg');
    if (father && mother && puppiesDiv && svg) {
      drawArrowsForLitter(block, father, mother, puppiesDiv, svg);
    }
  });
});

// Загрузка JSON с данными и построение дерева
fetch('data.json')
  .then(res => res.json())
  .then(data => {
    window.currentData = data;
    buildTree(data);
  })
  .catch(err => {
    console.error('Ошибка при загрузке данных:', err);
  });
</script>

</body>
</html>
