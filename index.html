<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Генеалогическое древо собак с одной колонкой разбивкой по годам</title>
<style>
  body {
    font-family: Arial, sans-serif;
    padding: 20px;
    margin: 0;
    background: #fafafa;
  }
  .tree {
    max-width: 1200px;
    margin: 0 auto;
    position: relative;
  }
  .year-group {
    border-left: 6px solid;
    padding-left: 15px;
    margin-bottom: 60px;
  }
  .year-label {
    font-weight: bold;
    font-size: 20px;
    margin-bottom: 15px;
  }
  .items-row {
    display: flex;
    gap: 40px;
    flex-wrap: nowrap;
    overflow-x: auto;
    padding-bottom: 15px;
  }
  .dog {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    background: #f0f0f0;
    box-shadow: 0 0 8px rgba(0,0,0,0.1);
    text-align: center;
    font-size: 14px;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding-top: 10px;
    position: relative;
    flex-shrink: 0;
  }
  .dog img {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    object-fit: cover;
    margin-bottom: 5px;
    user-select: none;
  }
  .male { border: 3px solid #3399ff; }
  .female { border: 3px solid #ff6699; }
  .birthday {
    font-size: 11px;
    color: #555;
    position: absolute;
    bottom: 5px;
    width: 100%;
  }
  .litter-container {
    border-radius: 15px;
    border: 2px solid #999;
    padding: 12px;
    background: #fff;
    display: flex;
    flex-direction: column;
    gap: 8px;
    min-width: 220px;
    flex-shrink: 0;
  }
  .litter-name {
    font-weight: bold;
    font-size: 16px;
    text-align: center;
  }
  .puppies-row {
    display: flex;
    gap: 15px;
    justify-content: center;
    flex-wrap: nowrap;
    overflow-x: auto;
  }
  svg#arrows-svg {
    position: absolute;
    top: 0;
    left: 0;
    pointer-events: none;
    overflow: visible;
    width: 100%;
    height: 100%;
  }
</style>
</head>
<body>

<div class="tree" id="tree-container">
  <svg id="arrows-svg"></svg>
</div>

<script>
  const yearColors = [
    '#d0f0c0', '#f0d0c0', '#c0d0f0', '#f0f0c0', '#d0c0f0'
  ];

  function formatDate(dog) {
    const dayStr = dog.day ? dog.day.toString().padStart(2,'0') + '.' : '';
    const monthStr = dog.month ? dog.month.toString().padStart(2,'0') + '.' : '';
    return dayStr + monthStr + dog.year;
  }

  // Возвращает числовой ключ для сортировки дат рождения собак
  function dateToComparable(dog) {
    const y = dog.year || 9999;
    const m = dog.month || 12;
    const d = dog.day || 31;
    return y*10000 + m*100 + d;
  }

  function createDogNode(dog) {
    const dogDiv = document.createElement('div');
    dogDiv.classList.add('dog', dog.sex === 'male' ? 'male' : 'female');
    dogDiv.dataset.name = dog.name;

    const img = document.createElement('img');
    img.src = dog.photo;
    img.alt = dog.name;

    const nameDiv = document.createElement('div');
    nameDiv.textContent = dog.name;

    const birthDiv = document.createElement('div');
    birthDiv.classList.add('birthday');
    birthDiv.textContent = formatDate(dog);

    dogDiv.appendChild(img);
    dogDiv.appendChild(nameDiv);
    dogDiv.appendChild(birthDiv);

    return dogDiv;
  }

  // Фильтрация собак без помётов и собаки, которые есть в помётах (чтобы не дублировать)
  function dogsNotInLitters(dogs, litters) {
    const puppiesInLitters = new Set();
    litters.forEach(l => {
      l.puppies.forEach(p => puppiesInLitters.add(p));
    });
    return dogs.filter(dog => !puppiesInLitters.has(dog.name));
  }

  // Группируем собак и помёты по году (для помётов - берем год из щенков, он должен быть одинаков)
  function groupByYear(dogs, litters) {
    const groups = {};

    // Добавляем собак без помётов
    const dogsAlone = dogsNotInLitters(dogs, litters);
    dogsAlone.forEach(d => {
      if (!d.year) return;
      if (!groups[d.year]) groups[d.year] = {dogs: [], litters: []};
      groups[d.year].dogs.push(d);
    });

    // Добавляем помёты, определяя год по первому щенку (все щенки одного года!)
    litters.forEach(litter => {
      if (!litter.puppies || litter.puppies.length === 0) return;
      const puppy = dogs.find(d => d.name === litter.puppies[0]);
      if (!puppy || !puppy.year) return;
      const y = puppy.year;
      if (!groups[y]) groups[y] = {dogs: [], litters: []};
      groups[y].litters.push(litter);
    });

    // Сортируем собаки по дате внутри года
    Object.values(groups).forEach(group => {
      group.dogs.sort((a, b) => dateToComparable(a) - dateToComparable(b));
      // сортируем щенков внутри помётов по дате
      group.litters.forEach(lit => {
        lit.puppies.sort((a, b) => {
          const da = dogs.find(d => d.name === a);
          const db = dogs.find(d => d.name === b);
          return dateToComparable(da) - dateToComparable(db);
        });
      });
      // сортируем помёты по дате щенков
      group.litters.sort((a, b) => {
        const da = dogs.find(d => d.name === a.puppies[0]);
        const db = dogs.find(d => d.name === b.puppies[0]);
        return dateToComparable(da) - dateToComparable(db);
      });
    });

    return groups;
  }

  function createLitterBlock(litter, dogs) {
    const litterBlock = document.createElement('div');
    litterBlock.classList.add('litter-container');
    litterBlock.dataset.litterName = litter.name;

    const nameDiv = document.createElement('div');
    nameDiv.classList.add('litter-name');
    nameDiv.textContent = litter.name || 'Помёт';

    const puppRow = document.createElement('div');
    puppRow.classList.add('puppies-row');

    litter.puppies.forEach(pName => {
      const dog = dogs.find(d => d.name === pName);
      if (dog) {
        puppRow.appendChild(createDogNode(dog));
      }
    });

    litterBlock.appendChild(nameDiv);
    litterBlock.appendChild(puppRow);
    return litterBlock;
  }

  function buildTree(data) {
    const container = document.getElementById('tree-container');
    container.innerHTML = '';

    const groups = groupByYear(data.dogs, data.litters);
    const sortedYears = Object.keys(groups).map(y => parseInt(y)).sort((a,b) => a - b);

    sortedYears.forEach((year, i) => {
      const color = yearColors[i % yearColors.length];
      const yearGroup = document.createElement('div');
      yearGroup.classList.add('year-group');
      yearGroup.style.borderColor = color;

      // Год
      const yearLabel = document.createElement('div');
      yearLabel.classList.add('year-label');
      yearLabel.textContent = year;
      yearGroup.appendChild(yearLabel);

      // Горизонтальный ряд - собаки и помёты
      const row = document.createElement('div');
      row.classList.add('items-row');

      // Добавляем собак
      groups[year].dogs.forEach(dog => {
        row.appendChild(createDogNode(dog));
      });

      // Добавляем помёты
      groups[year].litters.forEach(litter => {
        row.appendChild(createLitterBlock(litter, data.dogs));
      });

      yearGroup.appendChild(row);
      container.appendChild(yearGroup);
    });
    
    setTimeout(() => drawArrows(data), 80);
  }

  // Получить DOM собаки по имени из всего дерева
  function getDogElementByName(name) {
    return document.querySelector(`.dog[data-name="${name}"]`);
  }

  // Получить DOM блока помёта по имени
  function getLitterElementByName(name) {
    return document.querySelector(`.litter-container[data-litter-name="${name}"]`);
  }

  function createArrow(x1, y1, x2, y2) {
    const line = document.createElementNS("http://www.w3.org/2000/svg","line");
    line.setAttribute("x1", x1);
    line.setAttribute("y1", y1);
    line.setAttribute("x2", x2);
    line.setAttribute("y2", y2);
    line.setAttribute("stroke", "#444");
    line.setAttribute("stroke-width", "2");
    line.setAttribute("marker-end", "url(#arrowhead)");
    return line;
  }

  function drawArrows(data) {
    const svg = document.getElementById("arrows-svg");
    const container = document.getElementById("tree-container");
    svg.innerHTML = "";
    svg.style.width = container.offsetWidth + "px";
    svg.style.height = container.offsetHeight + "px";

    // Маркер стрелок
    const defs = document.createElementNS("http://www.w3.org/2000/svg", "defs");
    const marker = document.createElementNS("http://www.w3.org/2000/svg", "marker");
    marker.setAttribute("id", "arrowhead");
    marker.setAttribute("markerWidth", "10");
    marker.setAttribute("markerHeight", "7");
    marker.setAttribute("refX", "0");
    marker.setAttribute("refY", "3.5");
    marker.setAttribute("orient", "auto");
    const polygon = document.createElementNS("http://www.w3.org/2000/svg", "polygon");
    polygon.setAttribute("points", "0 0, 10 3.5, 0 7");
    polygon.setAttribute("fill", "#444");
    marker.appendChild(polygon);
    defs.appendChild(marker);
    svg.appendChild(defs);

    const containerRect = container.getBoundingClientRect();

    data.litters.forEach(litter => {
      const litterEl = getLitterElementByName(litter.name);
      if (!litterEl) return;
      const litterRect = litterEl.getBoundingClientRect();

      ['father', 'mother'].forEach(parentType => {
        const parentName = litter[parentType];
        if (!parentName) return;
        const parentEl = getDogElementByName(parentName);
        if (!parentEl) return;
        const parentRect = parentEl.getBoundingClientRect();

        // Координаты линий - снизу круга родителя к верху помёта
        const x1 = parentRect.left + parentRect.width / 2 - containerRect.left;
        const y1 = parentRect.top + parentRect.height - containerRect.top;

        const x2 = litterRect.left + litterRect.width / 2 - containerRect.left;
        const y2 = litterRect.top - containerRect.top;

        svg.appendChild(createArrow(x1, y1, x2, y2));
      });
    });
  }

  window.addEventListener('resize', () => {
  if (window.currentData) {
    setTimeout(() => drawArrows(window.currentData), 80);
  }
});

  fetch('data.json')
    .then(r => r.json())
    .then(data => {
      window.currentData = data;
      buildTree(data);
    })
    .catch(e => console.error('Ошибка загрузки JSON:', e));
</script>

</body>
</html>
